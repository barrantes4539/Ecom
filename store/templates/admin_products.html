{% extends 'base.html' %}
{% block content %}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-12"> <!-- Aumenté el ancho para acomodar la tabla -->
            <br/><br/>
            <h3 class="text-center">Productos</h3>
        
            <div class="table-responsive">
                <table id="table_products" class="table table-striped table-hover table-bordered">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Categoría</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr>
                            <td name="product_img">
                                <img style="height: 40px; width: 100%;" src="{{product.image.url}}" alt="..." />
                            </td>
                            <td name="product_name">
                                <span>{{ product.name }}</span>
                                <input type="text" id="product_name" name="product_name" class="form-control d-none" value="{{ product.name }}">
                            </td>
                            <td name="product_price">
                                <span>{{ product.price }}</span>
                                <input type="text" id="product_price" name="product_price" class="form-control d-none" value="{{ product.price }}">
                            </td>
                            {% comment %} <td name="product_category">
                                <span>{{ product.category.name }}</span>
                                <ul id="product_category_dropdown" class="dropdown-menu d-none" aria-labelledby="navbarDropdown">
                                    <li><hr class="dropdown-divider" /></li>
                                    {% for category in categories %}
                                        <li class="dropdown-item"><input type="text" id="product_category" name="product_category" class="form-control d-none" value="{{ product.price }}"></li>
                                    {% endfor %}
            
                                </ul>
                            </td> {% endcomment %}
                            <td name="product_category">
                                <span>{{ product.category.name }}</span>
                                <div id="category_dropdown" class="dropdown d-none">
                                    <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        {{ product.category.name }}
                                    </a>
                                    <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                                        <li><hr class="dropdown-divider"></li>
                                        {% for category in categories %}
                                            <li><a class="dropdown-item" name="product_category" href="#" data-category-id="{{ category.id }}">{{ category.name }}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </td>
                            
                            <td>
                                <button class="btn btn-info btn-edit">Editar</button>
                                <input type="hidden" id="product_id" name="product_id" value="{{ product.id }}">
                                <button type="button" id="update_product" class="btn btn-success btn-sm btn-confirm d-none" style="margin-right: 4px; margin-bottom: 10px;"><i class='bx bx-check'></i></button>
                                <button class="btn btn-sm btn-danger btn-delete d-none" style="margin-right: 4px;"><i class='bx bx-trash'></i></button>
                                <button class="btn btn-sm btn-outline-secondary btn-cancel d-none" style="margin-top: 10px;">Cancelar</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="button" id="add_product" class="btn btn-success btn-add">Añadir</button>
            </div>
        </div>
    </div>
</div>
{% comment %} 
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@mdo">Open modal for @mdo</button>
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@fat">Open modal for @fat</button>
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@getbootstrap">Open modal for @getbootstrap</button> {% endcomment %}

<div class="modal fade" id="add_product_modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Añadir Categoría</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="recipient-name" class="col-form-label">Categoría</label>
            <input type="text" class="form-control" id="add_product_name">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" id="confirm_add_product" >Añadir</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="delete_product_modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>¿Está seguro de eliminar la categoría?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirm_delete_product">Eliminar</button>
        </div>
      </div>
    </div>
  </div>

<script>
    $(document).ready(function() {
        $('#table_products').DataTable({
            "language": {
                "decimal":        "",
                "emptyTable":     "No hay datos disponibles en la tabla",
                "info":           "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                "infoEmpty":      "Mostrando 0 a 0 de 0 entradas",
                "infoFiltered":   "(filtrado de _MAX_ entradas totales)",
                "infoPostFix":    "",
                "thousands":      ",",
                "lengthMenu":     "Mostrar _MENU_ entradas",
                "loadingRecords": "Cargando...",
                "processing":     "Procesando...",
                "search":         "Buscar:",
                "zeroRecords":    "No se encontraron registros coincidentes",
                "paginate": {
                    "next":       "Siguiente",
                    "previous":   "Anterior"
                },
                "aria": {
                    "sortAscending":  ": activar para ordenar la columna ascendente",
                    "sortDescending": ": activar para ordenar la columna descendente"
                }
            },
            "order": [] // Deshabilitar ordenamiento inicial
        });
        $('.btn-edit').click(function() {
            // Encontrar elementos relacionados en la misma fila
            var row = $(this).closest('tr');
            var btnEditar = $(this);
            var btnConfirmar = row.find('.btn-confirm');
            var btnCancel = row.find('.btn-cancel');
            var btnDelete = row.find('.btn-delete');
            var spanNombre = row.find('td[name="product_name"] span');
            var inputNombre = row.find('td[name="product_name"] input[type="text"]');
            var spanPrecio = row.find('td[name="product_price"] span');
            var inputPrecio = row.find('td[name="product_price"] input[type="text"]');
            var spanCategoria = row.find('td[name="product_category"] span');
            var dropdownCategoria = row.find('.dropdown');
    
            // Ocultar botón Editar y mostrar botón Confirmar
            btnEditar.addClass('d-none');
            btnConfirmar.removeClass('d-none');
            btnCancel.removeClass('d-none');
            btnDelete.removeClass('d-none');
    
            // Mostrar input para editar nombre y ocultar span
            inputNombre.removeClass('d-none');
            spanNombre.addClass('d-none');
            inputPrecio.removeClass('d-none');
            spanPrecio.addClass('d-none');
    
            // Mostrar input para editar categoría y ocultar span y dropdown
            
            spanCategoria.addClass('d-none');
            dropdownCategoria.removeClass('d-none'); // Mostrar el dropdown
        });
    
        // Evento para el botón Confirmar
        $('.btn-confirm').click(function() {
            var row = $(this).closest('tr');
            var btnEditar = row.find('.btn-edit');
            var btnConfirmar = $(this);
            var btnCancel = row.find('.btn-cancel');
            var btnDelete = row.find('.btn-delete');
            var spanNombre = row.find('td[name="product_name"] span');
            var inputNombre = row.find('td[name="product_name"] input[type="text"]');
            var spanPrecio = row.find('td[name="product_price"] span');
            var inputPrecio = row.find('td[name="product_price"] input[type="text"]');
            var spanCategoria = row.find('td[name="product_category"] span');
            var dropdownCategoria = row.find('.dropdown');
            
            // Mostrar botón Editar y ocultar botón Confirmar
            btnEditar.removeClass('d-none');
            btnConfirmar.addClass('d-none');
            btnCancel.addClass('d-none');
            btnDelete.addClass('d-none');
            
            // Ocultar input de edición y mostrar span
            inputNombre.addClass('d-none');
            spanNombre.removeClass('d-none');
            inputPrecio.addClass('d-none');
            spanPrecio.removeClass('d-none');
            // Mostrar input para editar categoría y ocultar span y dropdown
            
            spanCategoria.removeClass('d-none');
            dropdownCategoria.addClass('d-none'); // Mostrar el dropdown
        });

        // Evento para el botón Cancelar
        $('.btn-cancel').click(function() {
            var row = $(this).closest('tr');
            var btnEditar = row.find('.btn-edit');
            var btnConfirmar = row.find('.btn-confirm');
            var btnCancel = $(this);
            var btnDelete = row.find('.btn-delete');
            var spanNombre = row.find('td[name="product_name"] span');
            var inputNombre = row.find('td[name="product_name"] input[type="text"]');
            var spanPrecio = row.find('td[name="product_price"] span');
            var inputPrecio = row.find('td[name="product_price"] input[type="text"]');
            var spanCategoria = row.find('td[name="product_category"] span');
            var dropdownCategoria = row.find('.dropdown');
            
            // Mostrar botón Editar y ocultar botón Confirmar
            btnEditar.removeClass('d-none');
            btnConfirmar.addClass('d-none');
            btnCancel.addClass('d-none');
            btnDelete.addClass('d-none');
            
            // Ocultar input de edición y mostrar span
            inputNombre.addClass('d-none');
            spanNombre.removeClass('d-none');
            inputPrecio.addClass('d-none');
            spanPrecio.removeClass('d-none');

            // Mostrar input para editar categoría y ocultar span y dropdown
            spanCategoria.removeClass('d-none');
            dropdownCategoria.addClass('d-none'); // Mostrar el dropdown
        });
    
        // Evento para actualizar categoría
// Evento para actualizar producto
        $(document).on('click', '#update_product', function(e) {
            e.preventDefault();

            var row = $(this).closest('tr');
            var productId = row.find('#product_id').val();
            var productName = row.find('#product_name').val();
            var productPrice = row.find('#product_price').val();
            var productCategory = row.find('td[name="product_category"] .nav-link').attr('data-category-id'); // Obtener el ID de la categoría seleccionada

            $.ajax({
                type: 'POST',
                url: '{% url 'update_products' %}',
                data: {
                    product_id: productId,
                    product_name: productName,
                    product_price: productPrice,
                    product_category: productCategory, // Incluir el ID de la categoría
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    action: 'post'
                },
                success: function(response) {
                    if (response && response.message) {
                        swal("Éxito", response.message, "success")
                            .then(function() {
                                window.location.reload(); // Recargar la página después de añadir la categoría
                            });
                    } else {
                        swal("Éxito", "Producto agregada exitosamente", "success")
                            .then(function() {
                                window.location.reload(); // Recargar la página después de añadir la categoría
                            });
                    }
                },
                error: function(xhr, errmsg, err) {
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        swal("Error", xhr.responseJSON.error, "error");
                    } else {
                        swal("Error", "Ocurrió un problema en el servidor", "error");
                    }
                }
            });
        });

        // Evento para añadir categoría
        $(document).on('click', '#confirm_add_product', function(e) {
            e.preventDefault();
            var new_product = $('#add_product_name').val();
            
            $.ajax({
                type: 'POST',
                url: '{% url 'add_categories' %}',
                data: {
                    new_product_name: new_product,
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    action: 'post'
                },
                success: function(response) {
                    if (response && response.message) {
                        swal("Éxito", response.message, "success")
                            .then(function() {
                                window.location.reload(); // Recargar la página después de añadir la categoría
                            });
                    } else {
                        swal("Éxito", "Producto agregada exitosamente", "success")
                            .then(function() {
                                window.location.reload(); // Recargar la página después de añadir la categoría
                            });
                    }
                },
                error: function(xhr, errmsg, err) {
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        swal("Error", xhr.responseJSON.error, "error");
                    } else {
                        swal("Error", "Ocurrió un problema en el servidor", "error");
                    }
                }
            });
        });
        // Evento para actualizar categoría
        $(document).on('click', '#delete_product', function(e) {
            e.preventDefault();
    
            var row = $(this).closest('tr');
            var productId = row.find('#product_id').val();
            var productName = row.find('#product_name').val();
            
            $.ajax({
                type: 'POST',
                url: '{% url 'delete_categories' %}',
                data: {
                    product_id: productId,
                    product_name: productName,
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    action: 'post'
                },
                success: function(response) {
                    if (response && response.message) {
                        swal("Éxito", response.message, "success")
                            .then(function() {
                                window.location.reload(); // Recargar la página después de eliminar la categoría
                            });
                    } else {
                        swal("Éxito", "Producto eliminada correctamente", "success")
                            .then(function() {
                                window.location.reload(); // Recargar la página después de eliminar la categoría
                            });
                    }
                },
                error: function(xhr, errmsg, err) {
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        swal("Error", xhr.responseJSON.error, "error");
                    } else {
                        swal("Error", "Ocurrió un problema en el servidor", "error");
                    }
                }
            });
        });
        $('#add_product').click(function() {
            $('#add_product_modal').modal('show');
        });



        $('#category_dropdown .dropdown-item').click(function(e) {
            e.preventDefault();
            
            // Obtener el texto de la categoría seleccionada
            var nombreCategoria = $(this).text().trim();
            
            // Actualizar el texto del span dentro de la celda
            $(this).closest('td[name="product_category"]').find('span').text(nombreCategoria);
            
            // Actualizar el texto del enlace que desencadena el dropdown
            var dropdownToggle = $(this).closest('#category_dropdown').find('.nav-link');
            dropdownToggle.text(nombreCategoria);
            dropdownToggle.attr('data-category-id', $(this).data('category-id')); // Agregar el ID de la categoría como atributo data
            
            // Opcionalmente, cerrar el dropdown después de seleccionar
            $(this).closest('.dropdown-menu').removeClass('show');
        });
        
    });
</script>

{% endblock %}
