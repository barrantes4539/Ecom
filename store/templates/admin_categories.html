{% extends 'base.html' %}
{% block content %}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-4 col-md-12">
            <br/><br/>
            <h3 class="text-center">Categories</h3>
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col" class="align-middle text-center"></th>
                            <th scope="col" class="align-middle text-center">Nombre</th>
                            <th scope="col" class="align-middle text-center">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category in categories %}
                        <tr>
                            <td class="align-middle text-center" name="category_id">{{ category.id }}</td>
                            <td class="align-middle text-center" name="category_name">
                                <span>{{ category.name }}</span>
                                <input type="text" id="category_name" name="category_name" class="form-control d-none" value="{{ category.name }}">
                            </td>
                            <td class="d-flex justify-content-center">
                                <button class="btn btn-info btn-edit">Editar</button>
                                <input type="hidden" id="category_id" name="category_id" value="{{ category.id }}">
                                <button type="button" id="update_category" class="btn btn-success btn-sm btn-confirm d-none" style="margin-right: 4px;"><i class='bx bx-check'></i></button>
                                <button class="btn btn-sm btn-danger btn-delete d-none" style="margin-right: 4px;"><i class='bx bx-trash'></i></button>
                                <button class="btn btn-sm btn-outline-secondary btn-cancel d-none">Cancel</button>
                            </td>
                        </tr>
                        {% endfor %}  
                    </tbody>
                </table>
                <button type="button" id="add_category" class="btn btn-success btn-add">Añadir</button>
            </div>
        </div>
    </div>
</div>

{% comment %} <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@mdo">Open modal for @mdo</button>
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@fat">Open modal for @fat</button>
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@getbootstrap">Open modal for @getbootstrap</button>

<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">New message</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="recipient-name" class="col-form-label">Recipient:</label>
            <input type="text" class="form-control" id="recipient-name">
          </div>
          <div class="mb-3">
            <label for="message-text" class="col-form-label">Message:</label>
            <textarea class="form-control" id="message-text"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Send message</button>
      </div>
    </div>
  </div>
</div> {% endcomment %}

<script>
    $(document).ready(function() {
        // Evento para el botón Editar
        $('.btn-edit').click(function() {
            // Encontrar elementos relacionados en la misma fila
            var row = $(this).closest('tr');
            var btnEditar = $(this);
            var btnConfirmar = row.find('.btn-confirm');
            var btnCancel = row.find('.btn-cancel');
            var btnDelete = row.find('.btn-delete');
            var spanNombre = row.find('td[name="category_name"] span');
            var inputNombre = row.find('td[name="category_name"] input[type="text"]');
            
            // Ocultar botón Editar y mostrar botón Confirmar
            btnEditar.addClass('d-none');
            btnConfirmar.removeClass('d-none');
            btnCancel.removeClass('d-none');
            btnDelete.removeClass('d-none');
            
            // Mostrar input para editar nombre y ocultar span
            inputNombre.removeClass('d-none');
            spanNombre.addClass('d-none');
        });
    
        // Evento para el botón Confirmar
        $('.btn-confirm').click(function() {
            var row = $(this).closest('tr');
            var btnEditar = row.find('.btn-edit');
            var btnConfirmar = $(this);
            var btnCancel = row.find('.btn-cancel');
            var btnDelete = row.find('.btn-delete');
            var spanNombre = row.find('td[name="category_name"] span');
            var inputNombre = row.find('td[name="category_name"] input[type="text"]');
            
            // Mostrar botón Editar y ocultar botón Confirmar
            btnEditar.removeClass('d-none');
            btnConfirmar.addClass('d-none');
            btnCancel.addClass('d-none');
            btnDelete.addClass('d-none');
            
            // Ocultar input de edición y mostrar span
            inputNombre.addClass('d-none');
            spanNombre.removeClass('d-none');
        });

        // Evento para el botón Cancelar
        $('.btn-cancel').click(function() {
            var row = $(this).closest('tr');
            var btnEditar = row.find('.btn-edit');
            var btnConfirmar = row.find('.btn-confirm');
            var btnCancel = $(this);
            var btnDelete = row.find('.btn-delete');
            var spanNombre = row.find('td[name="category_name"] span');
            var inputNombre = row.find('td[name="category_name"] input[type="text"]');
            
            // Mostrar botón Editar y ocultar botón Confirmar
            btnEditar.removeClass('d-none');
            btnConfirmar.addClass('d-none');
            btnCancel.addClass('d-none');
            btnDelete.addClass('d-none');
            
            // Ocultar input de edición y mostrar span
            inputNombre.addClass('d-none');
            spanNombre.removeClass('d-none');
        });
    
        // Evento para actualizar categoría
        $(document).on('click', '#update_category', function(e) {
            e.preventDefault();
    
            var row = $(this).closest('tr');
            var categoryId = row.find('#category_id').val();
            var categoryName = row.find('#category_name').val();
            
            $.ajax({
                type: 'POST',
                url: '{% url 'update_categories' %}',
                data: {
                    category_id: categoryId,
                    category_name: categoryName,
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    action: 'post'
                },
                success: function(response) {
                    if (response && response.message) {
                        swal("Éxito", response.message, "success");
                        // Actualizar el nombre en el span de la fila actual
                        var spanNombre = row.find('td[name="category_name"] span');
                        spanNombre.text(categoryName);
                    } else {
                        swal("Éxito", "Producto actualizado exitosamente", "success");
                    }
                },
                error: function(xhr, errmsg, err) {
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        swal("Error", xhr.responseJSON.error, "error");
                    } else {
                        swal("Error", "Ocurrió un problema en el servidor", "error");
                    }
                }
            });
        });
    });
</script>

{% endblock %}
