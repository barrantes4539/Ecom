{% extends 'base.html' %}
{% block content %}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-4 col-md-12">
            <br/><br/>
            <h3 class="text-center">Categorías</h3>
                <div class="table-responsive">
                        <table id="table_categories" class="table table-striped table-hover table-bordered">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in categories %}
                                <tr>
                                    <td name="category_name">
                                        <span>{{ category.name }}</span>
                                        <input type="text" id="category_name" name="category_name" class="form-control d-none" value="{{ category.name }}">
                                    </td>
                                    <td>
                                        <button class="btn btn-info btn-edit">Editar</button>
                                        <input type="hidden" id="category_id" name="category_id" value="{{ category.id }}">
                                        <button type="button" id="update_category" class="btn btn-success btn-sm btn-confirm d-none"><i class='bx bx-check'></i></button>
                                        <button class="btn btn-sm btn-danger btn-delete d-none" id="delete_category"><i class='bx bx-trash'></i></button>
                                        <button class="btn btn-sm btn-outline-secondary btn-cancel d-none" style="margin-top: 10px;">Cancelar</button>
                                    </td>
                                </tr>
                                {% endfor %}  
                            </tbody>
                        </table>

                        <button type="button" id="add_category" class="btn btn-success btn-add">Añadir</button>
                </div>
        
        </div>
    </div>
</div>
{% comment %} 
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@mdo">Open modal for @mdo</button>
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@fat">Open modal for @fat</button>
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@getbootstrap">Open modal for @getbootstrap</button> {% endcomment %}

<div class="modal fade" id="add_category_modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalLabel">Añadir Categoría</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="recipient-name" class="col-form-label">Categoría</label>
            <input type="text" class="form-control" id="add_category_name">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" id="confirm_add_category" >Añadir</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="delete_category_modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>¿Está seguro de eliminar la categoría?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirm_delete_category">Eliminar</button>
        </div>
      </div>
    </div>
  </div>

<script>
    $(document).ready(function() {
        $('#table_categories').DataTable({
            "language": {
                "decimal":        "",
                "emptyTable":     "No hay datos disponibles en la tabla",
                "info":           "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                "infoEmpty":      "Mostrando 0 a 0 de 0 entradas",
                "infoFiltered":   "(filtrado de _MAX_ entradas totales)",
                "infoPostFix":    "",
                "thousands":      ",",
                "lengthMenu":     "Mostrar _MENU_ entradas",
                "loadingRecords": "Cargando...",
                "processing":     "Procesando...",
                "search":         "Buscar:",
                "zeroRecords":    "No se encontraron registros coincidentes",
                "paginate": {
                    "next":       "Siguiente",
                    "previous":   "Anterior"
                },
                "aria": {
                    "sortAscending":  ": activar para ordenar la columna ascendente",
                    "sortDescending": ": activar para ordenar la columna descendente"
                }
            },
            "order": [] // Deshabilitar ordenamiento inicial
        });

        // Evento para el botón Editar
        $('.btn-edit').click(function() {
            // Encontrar elementos relacionados en la misma fila
            var row = $(this).closest('tr');
            var btnEditar = $(this);
            var btnConfirmar = row.find('.btn-confirm');
            var btnCancel = row.find('.btn-cancel');
            var btnDelete = row.find('.btn-delete');
            var spanNombre = row.find('td[name="category_name"] span');
            var inputNombre = row.find('td[name="category_name"] input[type="text"]');
            
            // Ocultar botón Editar y mostrar botón Confirmar
            btnEditar.addClass('d-none');
            btnConfirmar.removeClass('d-none');
            btnCancel.removeClass('d-none');
            btnDelete.removeClass('d-none');
            
            // Mostrar input para editar nombre y ocultar span
            inputNombre.removeClass('d-none');
            spanNombre.addClass('d-none');
        });
    
        // Evento para el botón Confirmar
        $('.btn-confirm').click(function() {
            var row = $(this).closest('tr');
            var btnEditar = row.find('.btn-edit');
            var btnConfirmar = $(this);
            var btnCancel = row.find('.btn-cancel');
            var btnDelete = row.find('.btn-delete');
            var spanNombre = row.find('td[name="category_name"] span');
            var inputNombre = row.find('td[name="category_name"] input[type="text"]');
            
            // Mostrar botón Editar y ocultar botón Confirmar
            btnEditar.removeClass('d-none');
            btnConfirmar.addClass('d-none');
            btnCancel.addClass('d-none');
            btnDelete.addClass('d-none');
            
            // Ocultar input de edición y mostrar span
            inputNombre.addClass('d-none');
            spanNombre.removeClass('d-none');
        });

        // Evento para el botón Cancelar
        $('.btn-cancel').click(function() {
            var row = $(this).closest('tr');
            var btnEditar = row.find('.btn-edit');
            var btnConfirmar = row.find('.btn-confirm');
            var btnCancel = $(this);
            var btnDelete = row.find('.btn-delete');
            var spanNombre = row.find('td[name="category_name"] span');
            var inputNombre = row.find('td[name="category_name"] input[type="text"]');
            
            // Mostrar botón Editar y ocultar botón Confirmar
            btnEditar.removeClass('d-none');
            btnConfirmar.addClass('d-none');
            btnCancel.addClass('d-none');
            btnDelete.addClass('d-none');
            
            // Ocultar input de edición y mostrar span
            inputNombre.addClass('d-none');
            spanNombre.removeClass('d-none');
        });
    
        // Evento para actualizar categoría
        $(document).on('click', '#update_category', function(e) {
            e.preventDefault();
    
            var row = $(this).closest('tr');
            var categoryId = row.find('#category_id').val();
            var categoryName = row.find('#category_name').val();
            
            $.ajax({
                type: 'POST',
                url: '{% url 'update_categories' %}',
                data: {
                    category_id: categoryId,
                    category_name: categoryName,
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    action: 'post'
                },
                success: function(response) {
                    if (response && response.message) {
                        swal("Éxito", response.message, "success");
                        // Actualizar el nombre en el span de la fila actual
                        var spanNombre = row.find('td[name="category_name"] span');
                        spanNombre.text(categoryName);
                    } else {
                        swal("Éxito", "Producto actualizado exitosamente", "success");
                    }
                },
                error: function(xhr, errmsg, err) {
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        swal("Error", xhr.responseJSON.error, "error");
                    } else {
                        swal("Error", "Ocurrió un problema en el servidor", "error");
                    }
                }
            });
        });

        // Evento para añadir categoría
        $(document).on('click', '#confirm_add_category', function(e) {
            e.preventDefault();
            var new_category = $('#add_category_name').val();
            
            $.ajax({
                type: 'POST',
                url: '{% url 'add_categories' %}',
                data: {
                    new_category_name: new_category,
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    action: 'post'
                },
                success: function(response) {
                    if (response && response.message) {
                        swal("Éxito", response.message, "success")
                            .then(function() {
                                window.location.reload(); // Recargar la página después de añadir la categoría
                            });
                    } else {
                        swal("Éxito", "Categoría agregada exitosamente", "success")
                            .then(function() {
                                window.location.reload(); // Recargar la página después de añadir la categoría
                            });
                    }
                },
                error: function(xhr, errmsg, err) {
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        swal("Error", xhr.responseJSON.error, "error");
                    } else {
                        swal("Error", "Ocurrió un problema en el servidor", "error");
                    }
                }
            });
        });
        // Evento para actualizar categoría
        $(document).on('click', '#delete_category', function(e) {
            e.preventDefault();
    
            var row = $(this).closest('tr');
            var categoryId = row.find('#category_id').val();
            var categoryName = row.find('#category_name').val();
            
            $.ajax({
                type: 'POST',
                url: '{% url 'delete_categories' %}',
                data: {
                    category_id: categoryId,
                    category_name: categoryName,
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    action: 'post'
                },
                success: function(response) {
                    if (response && response.message) {
                        swal("Éxito", response.message, "success")
                            .then(function() {
                                window.location.reload(); // Recargar la página después de eliminar la categoría
                            });
                    } else {
                        swal("Éxito", "Categoría eliminada correctamente", "success")
                            .then(function() {
                                window.location.reload(); // Recargar la página después de eliminar la categoría
                            });
                    }
                },
                error: function(xhr, errmsg, err) {
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        swal("Error", xhr.responseJSON.error, "error");
                    } else {
                        swal("Error", "Ocurrió un problema en el servidor", "error");
                    }
                }
            });
        });
        $('#add_category').click(function() {
            $('#add_category_modal').modal('show');
        });
    });
</script>

{% endblock %}
